<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <title>Cloud Medical Fees mySiss</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: white;
    }

    .container {
      display: flex;
    }

    .sidebar {
      width: 180px;
      background-color: #eee6f8;
      padding: 20px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    
    .sidebar-menu {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex-grow: 1; 
    }

    .sidebar-footer {
      margin-top: auto;
      margin-bottom: 10px; 
    }
    
    .sidebar a[href="login.html"] {
      position: relative;
      bottom: 30px;
    }

    a[href="login.html"] {
      position: relative;
      bottom: 10px;
    }

    .logout {
      color: purple;
      text-decoration: none;
      font-weight: bold;
    }
    
    .sidebar h1 {
      color: purple;
      font-weight: bold;
      font-size: 50px;
      margin-bottom: 30px;
    }

    .sidebar a {
      display: block;
      margin: 20px 0;
      color: purple;
      text-decoration: none;
      font-weight: bold;
    }

    .main {
      margin-left: 240px;
      flex: 1;
      background-color: white;
      padding: 20px 40px;
    }
    
    .radio-group {
      display: flex;  
      font-size: 18px;
      margin-bottom: 10px;
    }
    
    .radio-group label {
      display: inline-flex;
      align-items: center;
      margin-right: 30px;
      gap: 0px;
    }

    .form-section {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .form-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 10px;
    }

    label {
      min-width: 140px;
    }

    input, select {
      padding: 6px;
      width: 200px;
    }

    .btn {
      padding: 8px 16px;
      margin-top: 10px;
      margin-right: 10px;
      background-color: purple;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .hidden {
      display: none;
    }

    .table-section {
      background-color: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 13px;
    }

    table th, table td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: left;
    }

    table th {
      background-color: #f0f0f0;
    }
    
    th.col-select, td.col-select {
      width: 20px;
      min-width: 20px;
      max-width: 20px;
      padding: 0;
      text-align: center;
      vertical-align: middle;
      position: relative;
    }

    td.col-select input[type="checkbox"],
    th.col-select input[type="checkbox"] {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      margin: 0;
      padding: 0;
    }

    h3 {
      font-size: 16px;
      margin-top: 0;
    }
    
    .subrayado {
      text-decoration: underline;
    }
    
    td.col-select {
      position: relative;
      width: 40px;
      padding: 0;
    }

    .btn-icon {
      display: inline-block;
      padding: 8px;
      border-radius: 8px;
      background-color: purple; 
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-left: 40px;
    }

    .btn-icon:hover {
      background-color: #b80bd7;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
        
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 400px;
      border-radius: 10px;
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
      position: relative;
    }
        
    .close {
      position: absolute;
      right: 15px;
      top: 10px;
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
        
    .close:hover {
      color: black;
    }
        
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
      gap: 10px;
    }
        
    .modal-buttons button {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
        
    .modal-buttons .accept {
      background-color: purple;
      color: white;
    }
        
    .modal-buttons .cancel {
      background-color: #ddd;
    }

    /* Estilos adicionales para la funcionalidad */
    .tab-container {
      margin-top: 20px;
    }
    
    .tab-buttons {
      display: flex;
      margin-bottom: 10px;
    }
    
    .tab-button {
      padding: 8px 16px;
      background-color: #eee;
      border: none;
      cursor: pointer;
      margin-right: 5px;
      border-radius: 5px 5px 0 0;
    }
    
    .tab-button.active {
      background-color: purple;
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .filter-section {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      align-items: flex-end;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    
    .factura-details {
      margin-top: 20px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 5px;
      display: none;
    }
    
    .status-green {
      color: green;
    }
    
    .status-red {
      color: red;
    }
    
    .action-buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    
    .devolucion-fields {
      margin-top: 15px;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 5px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div class="sidebar-content">
        <h1>mySiss</h1>
        <a href="index.html">Radicacion de facturas</a>
        <a href="dev_Fact.html" style="text-decoration: underline;">Devolucion de facturas</a>
        <a href="carg_obj.html">Cargue de objeciones</a>
        <a href="gest_obj.html">Gestion de objeciones</a>
        <a href="conc_obj.html">Conciliacion de objeciones</a>
      </div>
      <a href="../login.html" class="logout">Cerrar sesión</a>
    </div>

    <div class="main">
      <h2>Devolución de facturas</h2>
      
      <div class="tab-container">
        <div class="tab-buttons">
          <button class="tab-button active" onclick="openTab('registrar')">Registrar devolución</button>
          <button class="tab-button" onclick="openTab('consultar')">Consultar facturas devueltas</button>
        </div>
        
        <!-- Tab Registrar Devolución -->
        <div id="registrar" class="tab-content active">
          <div class="form-section">
            <h3>Criterios de búsqueda</h3>
            <div class="filter-section">
              <div class="filter-group">
                <label for="radicadoExterno">No. Radicado Externo</label>
                <input type="text" id="radicadoExterno" placeholder="Ingrese número">
              </div>
              
              <div class="filter-group">
                <label for="numeroFactura">No. Factura</label>
                <input type="text" id="numeroFactura" placeholder="Ingrese número">
              </div>
              
              <div class="filter-group">
                <label for="estadoFactura">Estado factura</label>
                <select id="estadoFactura">
                  <option value="RA">RADICADA</option>
                </select>
              </div>
              
              <div class="filter-group">
                <label for="fechaInicio">Fecha inicio radicación</label>
                <input type="date" id="fechaInicio">
              </div>
              
              <div class="filter-group">
                <label for="fechaFin">Fecha fin radicación</label>
                <input type="date" id="fechaFin">
              </div>
              
              <button class="btn" onclick="buscarFacturas()">Buscar</button>
            </div>
          </div>
          
          <div class="table-section">
            <h3>Facturas</h3>
            <table id="tablaFacturas">
              <thead>
                <tr>
                  <th class="col-select"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                  <th>Detalle</th>
                  <th>Nombre pagador</th>
                  <th>Número caso</th>
                  <th>Número de factura</th>
                  <th>Estado factura</th>
                  <th>Valor factura</th>
                  <th>Número radicación externo</th>
                  <th>Fecha y Hora radicación</th>
                  <th>Usuario modifica</th>
                  <th>Ver archivos</th>
                  <th>Semaforización Soportes</th>
                </tr>
              </thead>
              <tbody id="facturasBody">
                <!-- Datos se llenarán dinámicamente -->
              </tbody>
            </table>
          </div>
          
          <div id="detalleFactura" class="factura-details">
            <h3>Detalle Factura</h3>
            <div id="detalleContenido"></div>
          </div>
          
          <div id="devolucionFields" class="devolucion-fields">
            <h3>Registrar Devolución</h3>
            <div class="form-row">
              <label for="motivoDevolucion">Motivo Devolución:</label>
              <select id="motivoDevolucion" onchange="cargarSubMotivos()">
                <option value="">Seleccione un motivo</option>
              </select>
            </div>
            
            <div class="form-row">
              <label for="subMotivoDevolucion">Sub Motivo Devolución:</label>
              <select id="subMotivoDevolucion" disabled>
                <option value="">Seleccione un sub motivo</option>
              </select>
            </div>
            
            <div class="action-buttons">
              <button class="btn" onclick="registrarDevolucion()">Registrar devolución</button>
            </div>
          </div>
        </div>
        
        <!-- Tab Consultar Facturas Devueltas -->
        <div id="consultar" class="tab-content">
          <div class="form-section">
            <h3>Criterios de búsqueda</h3>
            <div class="filter-section">
              <div class="filter-group">
                <label for="consultaRadicadoExterno">No. Radicado Externo</label>
                <input type="text" id="consultaRadicadoExterno" placeholder="Ingrese número">
              </div>
              
              <div class="filter-group">
                <label for="consultaNumeroFactura">No. Factura</label>
                <input type="text" id="consultaNumeroFactura" placeholder="Ingrese número">
              </div>
              
              <div class="filter-group">
                <label for="consultaEstadoFactura">Estado factura</label>
                <select id="consultaEstadoFactura">
                  <option value="DE">DEVUELTA</option>
                </select>
              </div>
              
              <div class="filter-group">
                <label for="consultaFechaInicioRad">Fecha inicio radicación</label>
                <input type="date" id="consultaFechaInicioRad">
              </div>
              
              <div class="filter-group">
                <label for="consultaFechaFinRad">Fecha fin radicación</label>
                <input type="date" id="consultaFechaFinRad">
              </div>
              
              <div class="filter-group">
                <label for="consultaFechaInicioDev">Fecha inicio devolución</label>
                <input type="date" id="consultaFechaInicioDev">
              </div>
              
              <div class="filter-group">
                <label for="consultaFechaFinDev">Fecha fin devolución</label>
                <input type="date" id="consultaFechaFinDev">
              </div>
              
              <button class="btn" onclick="buscarFacturasDevueltas()">Buscar</button>
            </div>
          </div>
          
          <div class="table-section">
            <h3>Facturas Devueltas</h3>
            <table id="tablaFacturasDevueltas">
              <thead>
                <tr>
                  <th>Detalle</th>
                  <th>Nombre pagador</th>
                  <th>Número caso</th>
                  <th>Número de factura</th>
                  <th>Estado factura</th>
                  <th>Valor factura</th>
                  <th>Número radicación externo</th>
                  <th>Fecha y Hora radicación</th>
                  <th>Usuario modifica</th>
                  <th>Motivo Devolución</th>
                  <th>Sub Motivo Devolución</th>
                  <th>Fecha Devolución</th>
                  <th>Hora Devolución</th>
                  <th>Usuario Devolución</th>
                  <th>Semaforización carga soporte</th>
                  <th>Ver Archivos</th>
                </tr>
              </thead>
              <tbody id="facturasDevueltasBody">
                <!-- Datos se llenarán dinámicamente -->
              </tbody>
            </table>
          </div>
          
          <div id="detalleFacturaDevuelta" class="factura-details">
            <h3>Detalle Factura Devuelta</h3>
            <div id="detalleContenidoDevuelta"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para mensajes -->
  <div id="messageModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <p id="modalMessage"></p>
      <div class="modal-buttons">
        <button class="accept" onclick="closeModal()">Aceptar</button>
      </div>
    </div>
  </div>

  <script>
    // Datos iniciales para motivos y submotivos de devolución
    const motivosDevolucion = [
      { id: "M001", motivo: "Documentación incompleta" },
      { id: "M002", motivo: "Error en datos de factura" },
      { id: "M003", motivo: "Procedimiento no cubierto" },
      { id: "M004", motivo: "Falta de autorización" }
    ];

    const subMotivosDevolucion = [
      { id: "SM001", motivoId: "M001", subMotivo: "Falta historia clínica" },
      { id: "SM002", motivoId: "M001", subMotivo: "Falta orden médica" },
      { id: "SM003", motivoId: "M001", subMotivo: "Falta soporte de pago" },
      { id: "SM004", motivoId: "M002", subMotivo: "Error en identificación" },
      { id: "SM005", motivoId: "M002", subMotivo: "Error en valores" },
      { id: "SM006", motivoId: "M003", subMotivo: "Procedimiento no autorizado" },
      { id: "SM007", motivoId: "M004", subMotivo: "Autorización vencida" },
      { id: "SM008", motivoId: "M004", subMotivo: "Autorización no encontrada" }
    ];

    // Datos de ejemplo para facturas radicadas
    let facturasRadicadas = [
      {
        numRadicadoExt: "RE1001",
        numFactura: "FAC-2023-001",
        nombrePagador: "EPS SANITAS",
        numCaso: "C2023001",
        estadoFactura: "RADICADA",
        valorFactura: 1500000,
        fechaHoraRadicacion: "2023-05-10T14:30:00",
        usuarioModifica: "usuario1",
        semaforizacion: "verde",
        detalle: {
          paciente: "Juan Pérez",
          identificacion: "123456789",
          servicios: ["Consulta médica", "Laboratorio"],
          fechaServicio: "2023-05-08"
        }
      },
      {
        numRadicadoExt: "RE1002",
        numFactura: "FAC-2023-002",
        nombrePagador: "EPS SURA",
        numCaso: "C2023002",
        estadoFactura: "RADICADA",
        valorFactura: 2300000,
        fechaHoraRadicacion: "2023-05-11T10:15:00",
        usuarioModifica: "usuario2",
        semaforizacion: "rojo",
        detalle: {
          paciente: "María Gómez",
          identificacion: "987654321",
          servicios: ["Ecografía", "Rayos X"],
          fechaServicio: "2023-05-09"
        }
      }
    ];

    // Cargar datos desde localStorage si existen
    function cargarDatosLocalStorage() {
      const storedFacturas = localStorage.getItem('facturasRadicadas');
      const storedDevueltas = localStorage.getItem('facturasDevueltas');
      
      if (storedFacturas) {
        facturasRadicadas = JSON.parse(storedFacturas);
      }
      
      if (storedDevueltas) {
        facturasDevueltas = JSON.parse(storedDevueltas);
      }
    }

    // Guardar datos en localStorage
    function guardarDatosLocalStorage() {
      localStorage.setItem('facturasRadicadas', JSON.stringify(facturasRadicadas));
      localStorage.setItem('facturasDevueltas', JSON.stringify(facturasDevueltas));
    }

    // Inicializar la página
    document.addEventListener('DOMContentLoaded', function() {
      cargarDatosLocalStorage();
      cargarMotivosDevolucion();
      buscarFacturas(); // Mostrar facturas radicadas al cargar
    });

    // Función para cambiar entre pestañas
    function openTab(tabName) {
      const tabContents = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
      }
      
      const tabButtons = document.getElementsByClassName('tab-button');
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
      }
      
      document.getElementById(tabName).classList.add('active');
      event.currentTarget.classList.add('active');
      
      if (tabName === 'consultar') {
        buscarFacturasDevueltas();
      }
    }

    // Cargar motivos de devolución en el select
    function cargarMotivosDevolucion() {
      const selectMotivo = document.getElementById('motivoDevolucion');
      
      motivosDevolucion.forEach(motivo => {
        const option = document.createElement('option');
        option.value = motivo.id;
        option.textContent = `${motivo.id} - ${motivo.motivo}`;
        selectMotivo.appendChild(option);
      });
    }

    // Cargar submotivos según el motivo seleccionado
    function cargarSubMotivos() {
      const motivoId = document.getElementById('motivoDevolucion').value;
      const selectSubMotivo = document.getElementById('subMotivoDevolucion');
      
      // Limpiar select
      selectSubMotivo.innerHTML = '<option value="">Seleccione un sub motivo</option>';
      
      if (motivoId) {
        selectSubMotivo.disabled = false;
        const subMotivosFiltrados = subMotivosDevolucion.filter(sub => sub.motivoId === motivoId);
        
        subMotivosFiltrados.forEach(subMotivo => {
          const option = document.createElement('option');
          option.value = subMotivo.id;
          option.textContent = `${subMotivo.id} - ${subMotivo.subMotivo}`;
          selectSubMotivo.appendChild(option);
        });
      } else {
        selectSubMotivo.disabled = true;
      }
    }

    // Buscar facturas radicadas
    function buscarFacturas() {
      const radicadoExt = document.getElementById('radicadoExterno').value;
      const numFactura = document.getElementById('numeroFactura').value;
      const fechaInicio = document.getElementById('fechaInicio').value;
      const fechaFin = document.getElementById('fechaFin').value;
      
      let facturasFiltradas = facturasRadicadas;
      
      // Aplicar filtros
      if (radicadoExt) {
        facturasFiltradas = facturasFiltradas.filter(f => f.numRadicadoExt.includes(radicadoExt));
      }
      
      if (numFactura) {
        facturasFiltradas = facturasFiltradas.filter(f => f.numFactura.includes(numFactura));
      }
      
      if (fechaInicio) {
        facturasFiltradas = facturasFiltradas.filter(f => new Date(f.fechaHoraRadicacion) >= new Date(fechaInicio));
      }
      
      if (fechaFin) {
        facturasFiltradas = facturasFiltradas.filter(f => new Date(f.fechaHoraRadicacion) <= new Date(fechaFin + "T23:59:59"));
      }
      
      // Mostrar resultados
      mostrarFacturas(facturasFiltradas);
    }

    // Mostrar facturas en la tabla
    function mostrarFacturas(facturas) {
      const tbody = document.getElementById('facturasBody');
      tbody.innerHTML = '';
      
      if (facturas.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="12" style="text-align: center;">No se encontraron facturas</td>';
        tbody.appendChild(row);
        return;
      }
      
      facturas.forEach((factura, index) => {
        const row = document.createElement('tr');
        
        // Formatear fecha
        const fecha = new Date(factura.fechaHoraRadicacion);
        const fechaFormateada = fecha.toLocaleDateString() + ' ' + fecha.toLocaleTimeString();
        
        row.innerHTML = `
          <td class="col-select"><input type="checkbox" id="select-${index}" onclick="habilitarDevolucion()"></td>
          <td><i class="fas fa-search" onclick="mostrarDetalleFactura(${index})" style="cursor: pointer;"></i></td>
          <td>${factura.nombrePagador}</td>
          <td>${factura.numCaso}</td>
          <td>${factura.numFactura}</td>
          <td>${factura.estadoFactura}</td>
          <td>$${factura.valorFactura.toLocaleString()}</td>
          <td>${factura.numRadicadoExt}</td>
          <td>${fechaFormateada}</td>
          <td>${factura.usuarioModifica}</td>
          <td><i class="fas fa-file-alt" style="cursor: pointer;"></i></td>
          <td><i class="fas fa-circle ${factura.semaforizacion === 'verde' ? 'status-green' : 'status-red'}"></i></td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Mostrar detalle de una factura
    function mostrarDetalleFactura(index) {
      const factura = facturasRadicadas[index];
      const detalleDiv = document.getElementById('detalleContenido');
      
      detalleDiv.innerHTML = `
        <p><strong>Paciente:</strong> ${factura.detalle.paciente}</p>
        <p><strong>Identificación:</strong> ${factura.detalle.identificacion}</p>
        <p><strong>Fecha servicio:</strong> ${factura.detalle.fechaServicio}</p>
        <p><strong>Servicios:</strong></p>
        <ul>
          ${factura.detalle.servicios.map(servicio => `<li>${servicio}</li>`).join('')}
        </ul>
      `;
      
      document.getElementById('detalleFactura').style.display = 'block';
    }

    // Seleccionar/deseleccionar todas las facturas
    function toggleSelectAll() {
      const checkboxes = document.querySelectorAll('#facturasBody input[type="checkbox"]');
      const selectAll = document.getElementById('selectAll').checked;
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
      });
      
      habilitarDevolucion();
    }

    // Habilitar campos de devolución cuando se selecciona una factura
    function habilitarDevolucion() {
      const checkboxes = document.querySelectorAll('#facturasBody input[type="checkbox"]:checked');
      
      if (checkboxes.length > 0) {
        document.getElementById('devolucionFields').style.display = 'block';
      } else {
        document.getElementById('devolucionFields').style.display = 'none';
      }
    }

    // Registrar una devolución
    function registrarDevolucion() {
      const motivoId = document.getElementById('motivoDevolucion').value;
      const subMotivoId = document.getElementById('subMotivoDevolucion').value;
      
      if (!motivoId || !subMotivoId) {
        showMessage('Por favor diligenciar los campos habilitados');
        return;
      }
      
      // Obtener motivo y sub motivo seleccionados
      const motivo = motivosDevolucion.find(m => m.id === motivoId);
      const subMotivo = subMotivosDevolucion.find(sm => sm.id === subMotivoId);
      
      // Obtener facturas seleccionadas
      const checkboxes = document.querySelectorAll('#facturasBody input[type="checkbox"]:checked');
      const indicesSeleccionados = Array.from(checkboxes).map(cb => parseInt(cb.id.split('-')[1]));
      
      // Validar días hábiles para devolución
      const hoy = new Date();
      let fueraDeRango = false;
      
      indicesSeleccionados.forEach(index => {
        const factura = facturasRadicadas[index];
        const fechaRadicacion = new Date(factura.fechaHoraRadicacion);
        const diasTranscurridos = Math.floor((hoy - fechaRadicacion) / (1000 * 60 * 60 * 24));
        
        // Supongamos que el límite son 15 días hábiles
        if (diasTranscurridos > 15) {
          fueraDeRango = true;
        }
      });
      
      if (fueraDeRango) {
        showMessage('Devolución fuera del rango de tiempo permitido');
        return;
      }
      
      // Procesar devolución para cada factura seleccionada
      indicesSeleccionados.forEach(index => {
        const factura = facturasRadicadas[index];
        
        // Crear registro de devolución
        const devolucion = {
          numFactura: factura.numFactura,
          numRadicadoExt: factura.numRadicadoExt,
          numRadicadoInt: factura.numCaso,
          motivoDevolucion: motivo.motivo,
          idMotivoDevolucion: motivo.id,
          subMotivoDevolucion: subMotivo.subMotivo,
          idSubMotivoDevolucion: subMotivo.id,
          fechaDevolucion: hoy.toISOString().split('T')[0],
          horaDevolucion: hoy.toTimeString().split(' ')[0],
          usuarioDevolucion: 'usuario_actual', // En una app real sería el usuario logueado
          detalle: factura.detalle
        };
        
        // Cambiar estado de la factura a DEVUELTA
        factura.estadoFactura = "DEVUELTA";
        factura.idEstadoFactura = "DE";
        
        // Mover factura a devueltas (en una app real sería una operación en base de datos)
        facturasDevueltas.push({...factura, ...devolucion});
        
        // Eliminar factura de radicadas
        facturasRadicadas.splice(index, 1);
      });
      
      // Guardar cambios en localStorage
      guardarDatosLocalStorage();
      
      // Mostrar mensaje de éxito
      showMessage('Devolución grabada exitosamente');
      
      // Actualizar tabla
      buscarFacturas();
      
      // Limpiar campos de devolución
      document.getElementById('motivoDevolucion').value = '';
      document.getElementById('subMotivoDevolucion').value = '';
      document.getElementById('subMotivoDevolucion').disabled = true;
      document.getElementById('devolucionFields').style.display = 'none';
      document.getElementById('selectAll').checked = false;
    }

    // Buscar facturas devueltas
    function buscarFacturasDevueltas() {
      const radicadoExt = document.getElementById('consultaRadicadoExterno').value;
      const numFactura = document.getElementById('consultaNumeroFactura').value;
      const fechaInicioRad = document.getElementById('consultaFechaInicioRad').value;
      const fechaFinRad = document.getElementById('consultaFechaFinRad').value;
      const fechaInicioDev = document.getElementById('consultaFechaInicioDev').value;
      const fechaFinDev = document.getElementById('consultaFechaFinDev').value;
      
      let facturasFiltradas = facturasDevueltas;
      
      // Aplicar filtros
      if (radicadoExt) {
        facturasFiltradas = facturasFiltradas.filter(f => f.numRadicadoExt.includes(radicadoExt));
      }
      
      if (numFactura) {
        facturasFiltradas = facturasFiltradas.filter(f => f.numFactura.includes(numFactura));
      }
      
      if (fechaInicioRad) {
        facturasFiltradas = facturasFiltradas.filter(f => new Date(f.fechaHoraRadicacion) >= new Date(fechaInicioRad));
      }
      
      if (fechaFinRad) {
        facturasFiltradas = facturasFiltradas.filter(f => new Date(f.fechaHoraRadicacion) <= new Date(fechaFinRad + "T23:59:59"));
      }
      
      if (fechaInicioDev) {
        facturasFiltradas = facturasFiltradas.filter(f => new Date(f.fechaDevolucion) >= new Date(fechaInicioDev));
      }
      
      if (fechaFinDev) {
        facturasFiltradas = facturasFiltradas.filter(f => new Date(f.fechaDevolucion) <= new Date(fechaFinDev + "T23:59:59"));
      }
      
      // Mostrar resultados
      mostrarFacturasDevueltas(facturasFiltradas);
    }

    // Mostrar facturas devueltas en la tabla
    function mostrarFacturasDevueltas(facturas) {
      const tbody = document.getElementById('facturasDevueltasBody');
      tbody.innerHTML = '';
      
      if (facturas.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="16" style="text-align: center;">No se encontraron facturas devueltas</td>';
        tbody.appendChild(row);
        return;
      }
      
      facturas.forEach((factura, index) => {
        const row = document.createElement('tr');
        
        // Formatear fechas
        const fechaRad = new Date(factura.fechaHoraRadicacion);
        const fechaRadFormateada = fechaRad.toLocaleDateString() + ' ' + fechaRad.toLocaleTimeString();
        
        const fechaDev = new Date(factura.fechaDevolucion + 'T' + factura.horaDevolucion);
        const fechaDevFormateada = fechaDev.toLocaleDateString();
        const horaDevFormateada = fechaDev.toLocaleTimeString();
        
        row.innerHTML = `
          <td><i class="fas fa-search" onclick="mostrarDetalleFacturaDevuelta(${index})" style="cursor: pointer;"></i></td>
          <td>${factura.nombrePagador}</td>
          <td>${factura.numCaso}</td>
          <td>${factura.numFactura}</td>
          <td>${factura.estadoFactura}</td>
          <td>$${factura.valorFactura.toLocaleString()}</td>
          <td>${factura.numRadicadoExt}</td>
          <td>${fechaRadFormateada}</td>
          <td>${factura.usuarioModifica}</td>
          <td>${factura.motivoDevolucion}</td>
          <td>${factura.subMotivoDevolucion}</td>
          <td>${fechaDevFormateada}</td>
          <td>${horaDevFormateada}</td>
          <td>${factura.usuarioDevolucion}</td>
          <td><i class="fas fa-circle ${factura.semaforizacion === 'verde' ? 'status-green' : 'status-red'}"></i></td>
          <td><i class="fas fa-file-alt" style="cursor: pointer;"></i></td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Mostrar detalle de una factura devuelta
    function mostrarDetalleFacturaDevuelta(index) {
      const factura = facturasDevueltas[index];
      const detalleDiv = document.getElementById('detalleContenidoDevuelta');
      
      detalleDiv.innerHTML = `
        <p><strong>Paciente:</strong> ${factura.detalle.paciente}</p>
        <p><strong>Identificación:</strong> ${factura.detalle.identificacion}</p>
        <p><strong>Fecha servicio:</strong> ${factura.detalle.fechaServicio}</p>
        <p><strong>Servicios:</strong></p>
        <ul>
          ${factura.detalle.servicios.map(servicio => `<li>${servicio}</li>`).join('')}
        </ul>
        <p><strong>Motivo devolución:</strong> ${factura.motivoDevolucion}</p>
        <p><strong>Sub motivo:</strong> ${factura.subMotivoDevolucion}</p>
        <p><strong>Fecha devolución:</strong> ${new Date(factura.fechaDevolucion).toLocaleDateString()} ${factura.horaDevolucion}</p>
        <p><strong>Usuario:</strong> ${factura.usuarioDevolucion}</p>
      `;
      
      document.getElementById('detalleFacturaDevuelta').style.display = 'block';
    }

    // Mostrar mensaje en modal
    function showMessage(message) {
      document.getElementById('modalMessage').textContent = message;
      document.getElementById('messageModal').style.display = 'block';
    }

    // Cerrar modal
    function closeModal() {
      document.getElementById('messageModal').style.display = 'none';
    }

    // Cerrar modal al hacer clic fuera de él
    window.onclick = function(event) {
      const modal = document.getElementById('messageModal');
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }

    // Datos de ejemplo para facturas devueltas
    let facturasDevueltas = [
      {
        numRadicadoExt: "RE1003",
        numFactura: "FAC-2023-003",
        nombrePagador: "EPS COOMEVA",
        numCaso: "C2023003",
        estadoFactura: "DEVUELTA",
        idEstadoFactura: "DE",
        valorFactura: 1800000,
        fechaHoraRadicacion: "2023-04-25T09:45:00",
        usuarioModifica: "usuario3",
        semaforizacion: "verde",
        motivoDevolucion: "Documentación incompleta",
        idMotivoDevolucion: "M001",
        subMotivoDevolucion: "Falta historia clínica",
        idSubMotivoDevolucion: "SM001",
        fechaDevolucion: "2023-05-05",
        horaDevolucion: "14:20:00",
        usuarioDevolucion: "auditor1",
        detalle: {
          paciente: "Carlos Rodríguez",
          identificacion: "456789123",
          servicios: ["Consulta especializada", "Laboratorio"],
          fechaServicio: "2023-04-20"
        }
      }
    ];
  </script>
</body>
</html>