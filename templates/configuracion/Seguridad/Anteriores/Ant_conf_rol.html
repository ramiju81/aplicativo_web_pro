<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Medical Fees mySiss</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        :root {
            --mysiss-purple: #800080;
            --mysiss-light-purple: #EBE3F2;
            --mysiss-hover-purple: #DFD1EE;
            --mysiss-active-bg: #D0B8E6;
        }
        .custom-radio {
            accent-color: var(--mysiss-purple);
        }
        .focus-outline:focus-visible {
            outline: 2px solid var(--mysiss-purple);
            outline-offset: 2px;
        }
        /* Estilos para el sidebar */
        .submenu {
            display: none;
            padding-left: 1rem;
        }
        .submenu.active {
            display: block;
        }
        .nav-link.active {
            background-color: var(--mysiss-active-bg);
            font-weight: bold;
            position: relative;
        }
        .nav-link.active::after {
            content: "";
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background-color: var(--mysiss-purple);
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        /* Estilo para el contenedor del menú */
        nav {
            display: flex;
            flex-direction: column;
            height: calc(100% - 80px);
            position: relative;
        }
        /* Estilo para el enlace de cerrar sesión */
        .logout-link {
            margin-top: auto;
            position: sticky;
            bottom: 0;
            background-color: var(--mysiss-light-purple);
            padding-top: 10px;
            padding-bottom: 10px;
        }
        .table-row-inactive {
            background-color: #f3f4f6;
            color: #6b7280;
        }
        .selected-row {
            background-color: #DFD1EE;
        }
        .action-btn {
            padding: 0.25rem 0.5rem;
            margin: 0 0.125rem;
            border-radius: 0.25rem;
            cursor: pointer;
        }
        .edit-btn {
            color: var(--mysiss-purple);
        }
        .delete-btn {
            color: #EF4444;
        }
        .permission-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            accent-color: var(--mysiss-purple);
            cursor: pointer;
        }
		/* Botón rojo fijo en esquina inferior derecha */
		#devClearBtn {
			position: fixed;
			bottom: 20px;
			right: 20px;
			background: red;
			color: white;
			border: none;
			padding: 10px;
			border-radius: 5px;
			cursor: pointer;
			z-index: 9999;
		}
    </style>
</head>
<body class="flex h-screen w-full overflow-hidden">
    <!-- Sidebar -->
    <div class="w-48 h-full bg-[var(--mysiss-light-purple)] flex flex-col">
        <div class="p-6">
            <h1 class="text-[var(--mysiss-purple)] text-5xl font-bold">mySiss</h1>
        </div>
        <nav class="mt-4 flex flex-col" aria-label="Menú principal">
            <!-- Configuración -->
            <div class="menu-item">
                <a href="#" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline flex justify-between items-center" onclick="toggleSubmenu('config-submenu', this)">
                    <strong>Configuración</strong>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </a>
                <div id="config-submenu" class="submenu">
                    <a href="conf_bas_1.html" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline block">Base</a>
                    <a href="conf_func_1.html" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline block">Funcionalidad</a>
                    <a href="conf_func_3.html" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline block">Funcionalidad New</a>
                    <a href="conf_role.html" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline block">Crear					Roles</a>
                </div>
            </div>
            
            <!-- Usuario -->
            <div class="menu-item">
                <a href="#" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline flex justify-between items-center" onclick="toggleSubmenu('usuario-submenu', this)">
                    <strong>Usuario</strong>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </a>
                <div id="usuario-submenu" class="submenu">
                    <a href="conf_usua_1.html" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline block">Crear Usuario</a>
                    <a href="conf_rol.html" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline block">Asignar Rol</a>
                </div>
            </div>
                        
            <!-- Módulos - Estructura de tres niveles -->
            <div class="menu-item">
                <a href="#" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline flex justify-between items-center" onclick="toggleSubmenu('modulos-submenu', this)">
                    <strong>Modulos</strong>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </a>
                <div id="modulos-submenu" class="submenu">
                    <!-- Honorarios -->
                    <div class="menu-item">
                        <a href="#" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline flex justify-between items-center" onclick="toggleSubmenu('honorarios-submenu', this)">
                            <span>Honorarios</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </a>
                        <div id="honorarios-submenu" class="submenu">
                            <a href="../Honorarios/configuracion.html" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline block">Configuración</a>
                            <a href="../Honorarios/Honorarios.html" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline block">Proceso</a>
                        </div>
                    </div>
                    
                    <!-- Auditoria -->
                    <div class="menu-item">
                        <a href="#" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline flex justify-between items-center" onclick="toggleSubmenu('auditoria-submenu', this)">
                            <span>Auditoria</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </a>
                        <div id="auditoria-submenu" class="submenu">
                            <a href="../auditoria/configuracion.html" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline block">Configuración</a>
                            <a href="../auditoria/auditoria.html" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline block">Proceso</a>
                        </div>
                    </div>
                    
                    <!-- Glosas -->
                    <div class="menu-item">
                        <a href="#" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline flex justify-between items-center" onclick="toggleSubmenu('glosas-submenu', this)">
                            <span>Glosas</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </a>
                        <div id="glosas-submenu" class="submenu">
                            <a href="../glosas/configuracion.html" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline block">Configuración</a>
                            <a href="../glosas/glosas.html" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors focus-outline block">Proceso</a>
                        </div>
                    </div>
                </div>
            </div>
            <a href="../login.html" class="nav-link py-2 px-6 text-[var(--mysiss-purple)] hover:bg-[var(--mysiss-hover-purple)] transition-colors mt-44 focus-outline">
                <strong>Cerrar Sesión</strong>
            </a>
        </nav>
    </div>

    <!-- Contenido principal -->
    <div class="flex-1 bg-white p-8 overflow-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-[var(--mysiss-purple)]">Roles</h2>
        </div>
		

        <!-- Pestañas modificadas -->
        <div class="mb-8 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px" id="tabs" role="tablist">
                <li role="presentation">
                    <button class="inline-block p-4 border-b-2 border-[var(--mysiss-purple)] text-[var(--mysiss-purple)] rounded-t-lg" id="usuarios-tab" type="button" role="tab">Roles-Usuario</button>
                </li>
            </ul>
			<div class="mt-4">
				<button id="addUserRoleBtn" class="px-4 py-2 bg-[var(--mysiss-purple)] text-white rounded-md focus-outline">
					Agregar Asociación
				</button>
			</div>
        </div>

        <!-- Contenido de pestañas modificado -->
        <div id="tab-content">
            <!-- Pestaña Roles-Usuario siempre visible -->
            <div class="p-4 rounded-lg bg-gray-50" id="usuarios" role="tabpanel">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rol</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Módulo</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crear</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modificar</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visualizar</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Eliminar</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="userRolesTableBody">
                            <!-- Filas se generan dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal para mensajes -->
    <div id="messageModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg max-w-md w-full">
            <h3 id="modalTitle" class="text-lg font-bold mb-4"></h3>
            <p id="modalMessage" class="mb-4"></p>
            <div class="flex justify-end">
                <button id="modalCloseBtn" class="px-4 py-2 bg-[var(--mysiss-purple)] text-white rounded-md focus-outline">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para búsqueda -->
    <div id="searchModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg max-w-2xl w-full">
            <h3 id="searchModalTitle" class="text-lg font-bold mb-4"></h3>
            <div class="mb-4">
                <input type="text" id="searchInput" class="border border-gray-300 rounded-md px-3 py-2 w-full focus-outline" placeholder="Buscar...">
            </div>
            <div class="max-h-96 overflow-y-auto mb-4">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Seleccionar</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="searchResults">
                        <!-- Resultados de búsqueda -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end">
                <button id="searchModalCloseBtn" class="px-4 py-2 bg-[var(--mysiss-purple)] text-white rounded-md focus-outline">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para búsqueda de usuarios -->
    <div id="userSearchModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg max-w-4xl w-full">
            <h3 id="userSearchModalTitle" class="text-lg font-bold mb-4">Buscar Usuario</h3>
            <div class="mb-4">
                <input type="text" id="userSearchInput" class="border border-gray-300 rounded-md px-3 py-2 w-full focus-outline" placeholder="Buscar por nombre, apellido o cédula...">
            </div>
            <div class="max-h-96 overflow-y-auto mb-4">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Apellido</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cédula</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cargo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Celular</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Seleccionar</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="userSearchResults">
                        <!-- Resultados de búsqueda de usuarios -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end">
                <button id="userSearchModalCloseBtn" class="px-4 py-2 bg-[var(--mysiss-purple)] text-white rounded-md focus-outline">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
	<!--
	<button id="devClearBtn">Limpiar</button>
	-->
<script>
    // Datos de usuarios de ejemplo
    const usuariosData = [
        { usuario: 'jperez', nombre: 'Juan', apellido: 'Pérez', cedula: '12345678', cargo: 'Administrador', celular: '3001234567' },
        { usuario: 'mgomez', nombre: 'María', apellido: 'Gómez', cedula: '87654321', cargo: 'Auditor', celular: '3007654321' },
        { usuario: 'lrodrig', nombre: 'Luis', apellido: 'Rodríguez', cedula: '11223344', cargo: 'Técnico', celular: '3001122334' },
        { usuario: 'amartin', nombre: 'Ana', apellido: 'Martínez', cedula: '44332211', cargo: 'Auxiliar', celular: '3004433221' }
    ];

    // Datos y configuraciones iniciales
    const config = {
        rolesData: [
            {
                rol: 'Administrativo',
                modulo: 'Honorarios',
                funcionalidad: 'Preliquidación',
                actividad: 'Filtrar preliquidación',
                crear: true,
                modificar: true,
                visualizar: true,
                eliminar: true
            },
            {
                rol: 'Técnico',
                modulo: 'Glosas',
                funcionalidad: 'Procesamiento',
                actividad: 'Revisión de glosas',
                crear: false,
                modificar: true,
                visualizar: true,
                eliminar: false
            },
            {
                rol: 'Auxiliar',
                modulo: 'Auditoria',
                funcionalidad: 'Verificación',
                actividad: 'Revisión de documentos',
                crear: false,
                modificar: false,
                visualizar: true,
                eliminar: false
            },
            {
                rol: 'Auditor',
                modulo: 'Auditoria',
                funcionalidad: 'Proceso completo',
                actividad: 'Todas las actividades',
                crear: true,
                modificar: true,
                visualizar: true,
                eliminar: true
            }
        ],
        userRolesData: JSON.parse(localStorage.getItem('userRolesData')) || [
            // Datos de ejemplo con múltiples módulos para algunos usuarios
            { usuario: 'jperez', rol: 'Administrativo', modulo: 'Honorarios', funcionalidad: 'Preliquidación', actividad: 'Filtrar preliquidación', crear: true, modificar: true, visualizar: true, eliminar: true },
            { usuario: 'jperez', rol: 'Auditor', modulo: 'Auditoria', funcionalidad: 'Proceso completo', actividad: 'Todas las actividades', crear: true, modificar: true, visualizar: true, eliminar: true },
            { usuario: 'jperez', rol: 'Técnico', modulo: 'Glosas', funcionalidad: 'Procesamiento', actividad: 'Revisión de glosas', crear: false, modificar: true, visualizar: true, eliminar: false },
            { usuario: 'mgomez', rol: 'Auditor', modulo: 'Auditoria', funcionalidad: 'Proceso completo', actividad: 'Todas las actividades', crear: true, modificar: true, visualizar: true, eliminar: true },
            { usuario: 'mgomez', rol: 'Técnico', modulo: 'Glosas', funcionalidad: 'Procesamiento', actividad: 'Revisión de glosas', crear: false, modificar: true, visualizar: true, eliminar: false },
            { usuario: 'lrodrig', rol: 'Técnico', modulo: 'Glosas', funcionalidad: 'Procesamiento', actividad: 'Revisión de glosas', crear: false, modificar: true, visualizar: true, eliminar: false },
            { usuario: 'amartin', rol: 'Auxiliar', modulo: 'Auditoria', funcionalidad: 'Verificación', actividad: 'Revisión de documentos', crear: false, modificar: false, visualizar: true, eliminar: false }
        ],
        modulosData: [
            { codigo: 'MH001', nombre: 'Honorarios' },
            { codigo: 'MG001', nombre: 'Glosas' },
            { codigo: 'MA001', nombre: 'Auditoria' }
        ],
        currentRow: null,
        selectedUserRoleRow: null,
        editingRow: null
    };

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        initApplication();
    });

    function initApplication() {
        renderUserRolesTable();
        setupMainEventListeners();
        setupMenuNavigation();
        setActiveMenu();
    }

    // Configuración del menú lateral - MODIFICADO PARA MANTENER TODO ABIERTO
    function setupMenuNavigation() {
        // Abrir todos los submenús al cargar
        document.querySelectorAll('.submenu').forEach(menu => {
            menu.classList.add('active');
        });
        
        // Rotar todas las flechas hacia abajo
        document.querySelectorAll('.menu-item > a.nav-link svg').forEach(icon => {
            icon.classList.add('rotate-180');
        });
        
        // Eliminar eventos de clic que abren/cierran menús
        const menuItems = document.querySelectorAll('.menu-item > a.nav-link');
        menuItems.forEach(item => {
            item.removeEventListener('click', toggleSubmenu);
        });
    }

    // Funcionalidad principal de la página
    function setupMainEventListeners() {
        // Botón Agregar Asociación
        document.getElementById('addUserRoleBtn').addEventListener('click', function() {
            const tableBody = document.getElementById('userRolesTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'table-row-active';
            newRow.dataset.id = 'new';
            
            newRow.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex">
                        <input type="text" class="search-user-input border rounded-l-md px-2 py-1 w-full" readonly>
                        <button class="search-user-btn px-2 py-1 bg-[var(--mysiss-purple)] text-white rounded-r-md">
                            ...
                        </button>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex">
                        <input type="text" class="search-role-input border rounded-l-md px-2 py-1 w-full" readonly>
                        <button class="search-role-btn px-2 py-1 bg-[var(--mysiss-purple)] text-white rounded-r-md">
                            ...
                        </button>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="text" class="modulo-input border rounded-md px-2 py-1 w-full" readonly>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <input type="checkbox" class="permission-checkbox crear-input">
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <input type="checkbox" class="permission-checkbox modificar-input">
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <input type="checkbox" class="permission-checkbox visualizar-input">
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <input type="checkbox" class="permission-checkbox eliminar-input">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button class="save-user-role-btn px-2 py-1 bg-[var(--mysiss-purple)] text-white rounded-md">
                        Guardar
                    </button>
                </td>
            `;
            
            tableBody.prepend(newRow);
            
            // Configurar eventos para la nueva fila
            setupNewRowEvents(newRow);
        });
        
        // Cerrar modales
        document.getElementById('modalCloseBtn').addEventListener('click', function() {
            document.getElementById('messageModal').classList.add('hidden');
        });
        
        document.getElementById('searchModalCloseBtn').addEventListener('click', function() {
            document.getElementById('searchModal').classList.add('hidden');
        });
        
        document.getElementById('userSearchModalCloseBtn').addEventListener('click', function() {
            document.getElementById('userSearchModal').classList.add('hidden');
        });
    }

    function setupNewRowEvents(row) {
        row.querySelector('.search-user-btn').addEventListener('click', function() {
            config.currentRow = row;
            showUserSearchModal();
        });
        
        row.querySelector('.search-role-btn').addEventListener('click', function() {
            config.currentRow = row;
            const rolesForSearch = config.rolesData.map(r => ({ 
                codigo: r.rol, 
                nombre: r.rol,
                modulo: r.modulo,
                funcionalidad: r.funcionalidad,
                actividad: r.actividad,
                crear: r.crear,
                modificar: r.modificar,
                visualizar: r.visualizar,
                eliminar: r.eliminar
            }));
            showSearchModal('Buscar Rol', rolesForSearch);
        });
        
        row.querySelector('.save-user-role-btn').addEventListener('click', function() {
            const inputs = row.querySelectorAll('input[type="text"]');
            const checkboxes = row.querySelectorAll('input[type="checkbox"]');
            
            const newUserRole = {
                usuario: inputs[0].value,
                rol: inputs[1].value,
                modulo: inputs[2].value,
                funcionalidad: '',
                actividad: '',
                crear: checkboxes[0].checked,
                modificar: checkboxes[1].checked,
                visualizar: checkboxes[2].checked,
                eliminar: checkboxes[3].checked
            };
            
            if (!newUserRole.usuario || !newUserRole.rol) {
                showMessage('Error', 'Usuario y Rol son obligatorios');
                return;
            }
            
            // Buscar funcionalidad y actividad correspondientes al rol seleccionado
            const selectedRole = config.rolesData.find(r => r.rol === newUserRole.rol);
            if (selectedRole) {
                newUserRole.funcionalidad = selectedRole.funcionalidad;
                newUserRole.actividad = selectedRole.actividad;
            }
            
            config.userRolesData.unshift(newUserRole);
            localStorage.setItem('userRolesData', JSON.stringify(config.userRolesData));
            renderUserRolesTable();
            showMessage('Éxito', 'Asociación agregada correctamente');
        });
    }

    function renderUserRolesTable() {
        const tableBody = document.getElementById('userRolesTableBody');
        tableBody.innerHTML = '';
        
        config.userRolesData.forEach((item, index) => {
            const row = document.createElement('tr');
            row.className = 'table-row-inactive';
            row.dataset.id = index;
            
            // Determinar si esta fila está en modo edición
            const isEditing = config.editingRow === index;
            
            if (isEditing) {
                // Modo edición - mostrar checkboxes para permisos
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${item.usuario}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.rol}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.modulo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <input type="checkbox" class="permission-checkbox crear-input" ${item.crear ? 'checked' : ''}>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <input type="checkbox" class="permission-checkbox modificar-input" ${item.modificar ? 'checked' : ''}>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <input type="checkbox" class="permission-checkbox visualizar-input" ${item.visualizar ? 'checked' : ''}>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <input type="checkbox" class="permission-checkbox eliminar-input" ${item.eliminar ? 'checked' : ''}>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap flex items-center">
                        <button class="save-edit-btn action-btn bg-[var(--mysiss-purple)] text-white rounded-md mr-2">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="cancel-edit-btn action-btn bg-gray-500 text-white rounded-md">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
                
                // Configurar eventos para los botones de edición
                row.querySelector('.save-edit-btn').addEventListener('click', function() {
                    // Actualizar los permisos
                    const checkboxes = row.querySelectorAll('input[type="checkbox"]');
                    config.userRolesData[index].crear = checkboxes[0].checked;
                    config.userRolesData[index].modificar = checkboxes[1].checked;
                    config.userRolesData[index].visualizar = checkboxes[2].checked;
                    config.userRolesData[index].eliminar = checkboxes[3].checked;
                    
                    // Guardar cambios
                    localStorage.setItem('userRolesData', JSON.stringify(config.userRolesData));
                    
                    // Salir del modo edición
                    config.editingRow = null;
                    renderUserRolesTable();
                    showMessage('Éxito', 'Permisos actualizados correctamente');
                });
                
                row.querySelector('.cancel-edit-btn').addEventListener('click', function() {
                    // Cancelar edición sin guardar cambios
                    config.editingRow = null;
                    renderUserRolesTable();
                });
            } else {
                // Modo visualización - mostrar texto para permisos
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${item.usuario}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.rol}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.modulo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${item.crear ? '✓' : '✗'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${item.modificar ? '✓' : '✗'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${item.visualizar ? '✓' : '✗'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${item.eliminar ? '✓' : '✗'}</td>
                    <td class="px-6 py-4 whitespace-nowrap flex items-center">
                        <button class="edit-btn action-btn" title="Editar permisos">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="delete-btn action-btn" title="Eliminar">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                // Configurar eventos para los botones
                row.querySelector('.edit-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    config.editingRow = index;
                    renderUserRolesTable();
                });
                
                row.querySelector('.delete-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (confirm('¿Eliminar esta asociación?')) {
                        config.userRolesData.splice(index, 1);
                        localStorage.setItem('userRolesData', JSON.stringify(config.userRolesData));
                        renderUserRolesTable();
                        showMessage('Éxito', 'Asociación eliminada');
                    }
                });
            }
            
            row.addEventListener('click', function() {
                document.querySelectorAll('#userRolesTableBody tr').forEach(r => {
                    r.classList.remove('selected-row');
                });
                this.classList.add('selected-row');
                config.selectedUserRoleRow = index;
            });
            
            tableBody.appendChild(row);
        });
    }

    // Funciones auxiliares
    function showSearchModal(title, items) {
        const modal = document.getElementById('searchModal');
        const results = document.getElementById('searchResults');
        
        document.getElementById('searchModalTitle').textContent = title;
        results.innerHTML = '';
        
        items.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4">${item.codigo}</td>
                <td class="px-6 py-4">${item.nombre}</td>
                <td class="px-6 py-4">
                    <button class="select-item-btn px-2 py-1 bg-[var(--mysiss-purple)] text-white rounded-md">
                        Seleccionar
                    </button>
                </td>
            `;
            
            row.querySelector('.select-item-btn').addEventListener('click', function() {
                if (config.currentRow) {
                    config.currentRow.querySelector('.search-role-input').value = item.nombre;
                    config.currentRow.querySelector('.modulo-input').value = item.modulo || '';
                    
                    // Actualizar los checkboxes de permisos según el rol seleccionado
                    const checkboxes = config.currentRow.querySelectorAll('input[type="checkbox"]');
                    checkboxes[0].checked = item.crear || false;
                    checkboxes[1].checked = item.modificar || false;
                    checkboxes[2].checked = item.visualizar || false;
                    checkboxes[3].checked = item.eliminar || false;
                }
                modal.classList.add('hidden');
            });
            
            results.appendChild(row);
        });
        
        document.getElementById('searchInput').value = '';
        modal.classList.remove('hidden');
    }

    function showUserSearchModal() {
        const modal = document.getElementById('userSearchModal');
        const results = document.getElementById('userSearchResults');
        results.innerHTML = '';
        
        usuariosData.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4">${user.usuario}</td>
                <td class="px-6 py-4">${user.nombre}</td>
                <td class="px-6 py-4">${user.apellido}</td>
                <td class="px-6 py-4">${user.cedula}</td>
                <td class="px-6 py-4">${user.cargo}</td>
                <td class="px-6 py-4">${user.celular}</td>
                <td class="px-6 py-4">
                    <button class="select-user-btn px-2 py-1 bg-[var(--mysiss-purple)] text-white rounded-md">
                        Seleccionar
                    </button>
                </td>
            `;
            
            row.querySelector('.select-user-btn').addEventListener('click', function() {
                if (config.currentRow) {
                    config.currentRow.querySelector('.search-user-input').value = user.usuario;
                }
                modal.classList.add('hidden');
            });
            
            results.appendChild(row);
        });
        
        modal.classList.remove('hidden');
    }

    function showMessage(title, message) {
        const modal = document.getElementById('messageModal');
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').textContent = message;
        modal.classList.remove('hidden');
    }

    function setActiveMenu() {
        const currentPath = window.location.pathname.split('/').pop() || 'conf_rol.html';
        
        document.querySelectorAll('.nav-link[href]').forEach(link => {
            const linkPath = link.getAttribute('href').split('/').pop();
            
            if (linkPath === currentPath) {
                link.classList.add('active');
            }
        });
    }

    // Filtrado de búsqueda
    document.getElementById('searchInput')?.addEventListener('input', function() {
        const term = this.value.toLowerCase();
        document.querySelectorAll('#searchResults tr').forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
        });
    });

    document.getElementById('userSearchInput')?.addEventListener('input', function() {
        const term = this.value.toLowerCase();
        document.querySelectorAll('#userSearchResults tr').forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
        });
    });

    // Cerrar modales al hacer clic fuera
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) this.classList.add('hidden');
        });
    });
	document.getElementById("devClearBtn").onclick = function() {
		localStorage.clear(); // Borra todo el localStorage
		alert("LocalStorage limpiado ✅");
	};
</script>
</body>
</html>